#!/bin/bash

dir="$HOME/.cache/clipboard-history"
mkdir -p "$dir"

if [ "$1" = "daemon" ]; then
    wl-paste -w sway-paste on-copy
elif [ "$1" = "lock" ]; then
    touch "$dir/.lock"
elif [ "$1" = "unlock" ]; then
    rm -f "$dir/.lock"
elif [ "$1" = "on-copy" ]; then
    [ -f "$dir/.lock" ] && exit
    cat > "$dir/$(date +%s)"
    find "$dir" -type f -size 0 -delete
    find "$dir" -type f -size +10000000c -delete
    find "$dir" -type f -print0 | sort -zn | head -z -n -200 | xargs -r -0 rm
elif [ "$1" = "dmenu" ]; then
    find "$dir" -type f -print0 | sort -znr | while IFS= read -r -d '' file; do
        mime="$(file --mime-type "$file" | cut -d' ' -f2)"
        if [ "$mime" = "text/plain" ]; then
            cat "$file"
        else
            printf '%s' "$file"
        fi
        printf '\0'
    done | dmenu -0 | while IFS= read -r -d '' result; do
        if [ -f "$result" ]; then
            wl-copy < "$result"
        else
            printf '%s' "$result" | sed -e 's/[[:space:]]*$//' | sed -Ez 's/\s+$//' | wl-copy
        fi
    done
else
    >&2 echo "Usage: sway-paste <daemon|lock|unlock|on-copy|dmenu>"
    exit 1
fi
